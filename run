#!/bin/sh

#d=-dpng
d='-dpngcairo size'

awk() {
	/usr/bin/awk "$@"
}

paste() {
	/usr/bin/paste "$@"
}

foo() {
	shift $1;
	la="$1"
}

# set most recent input file
foo $# "$@"

foo() {
	printf '%d/%d/%d' $3 $4 $2
}

# set date
co="$IFS"
IFS=-
da=`foo $la` || exit
IFS="$co"

awk '/state_testing_results/ { F = 1 } F { print }' "$la" >ratio
awk 'BEGIN { RS="," } $1 ~ /"total_tested":$/ { print $2 }' ratio >tested
awk 'BEGIN { RS="," } $1 ~ /"confirmed_cases":$/ { print $2 }' ratio >total
paste total tested | >ratio awk \
 '$2 != L { L = 100 * $1 / $2; printf("%d %s %.1f%%\n", NR - 1, L, L); L = $2 }'
co=`awk '{ t += $2 } END { printf("%.1f%%", t / NR) }' ratio`
./plot -sgt "$da"' cases_{confirmed} / tested_{total} '"$co" \
  "$d 800,440" -o ratio.png ratio

for co in Illinois Kane 'Chicago|Cook' \
  'McHenry|Lake|Kane|DuPage|Kendall|will|Grundy|Kankakee'; do
	for rs in 'confirmed cases' deaths 'total tested'; do
		./totals select="$co" result="$rs" "$@" | \
		  awk '{print NR-1,$1,$1}' >total

		# if there is zero, don't gen plots
		awk 'BEGIN{s=1}$1!="0"{s=0;exit}END{exit s}' total || break

		./plot -gst "$da $co" "$d 555,440" -o a.png -Ly total

		awk '{print $2}' total | ./cum | \
		  awk 'NF==2{print NR-1,$2,$1}' | tail>\%chg
		./plot -gst "$rs"' %chg' "$d 245,440" -o b.png \%chg

		convert +append a.png b.png +dither -colors 8 "$co"-"$rs".gif
		/bin/rm -f a.png b.png

		# no tested totals per county
		case "$co"-"$rs" in
		  Illinois-*)
			;;
		  *-deaths)
			break
			;;
		esac
	done
done
