#!/bin/sh

#d=-dpng
d='-dpngcairo size'

awk() {
	/usr/bin/awk "$@"
}

paste() {
	/usr/bin/paste "$@"
}

foo() {
	shift $1;
	la="$1"
}

# set most recent input file
foo $# "$@"

foo() {
	printf '%d/%d/%d' $3 $4 $2
}

# set date
co="$IFS"
IFS=-
da=`foo $la` || exit
IFS="$co"

awk '/state_testing_results/ { F = 1 } F { print }' "$la" >\%chg
awk 'BEGIN { RS="," } $1 ~ /"total_tested":$/ { print $2 }' \%chg >tested
awk 'BEGIN { RS="," } $1 ~ /"confirmed_cases":$/ { print $2 }' \%chg >total
awk 'BEGIN { RS="," } $(NF - 1) ~ /"testDate":$/ { print $NF }' \%chg | \
  paste - total tested | >ratio awk \
 '$3 != 0 { L = 100 * $2 / $3; printf("%s %s %.1f%%\n", $1, L, L) }'
co=`awk '{ t += $2 } END { printf("%.1f%%", t / NR) }' ratio`
./plot -sgt "$da"' cases_{confirmed} / tested_{total} '"$co" \
  "$d 800,440" -o ratio.png -T '"%m/%d/%Y"' ratio

# split on |
foo() {
	echo $*
}
IFS='|'

# r = n[(A/P)^(1/nt) - 1]
TVM='{
	A = index($NF, "-")
	j = substr($NF, 1, A - 1) + 0
	A = substr($NF, A + 11) + 0

	i = 1; d = index($i, "-") + 1
	while (i < NF) {
		n = j - substr($i, 1, d - 2)
		P = substr($i, d + 10) + 0
		i += 1
		d = index($i, "-") + 1

		print substr($i, d, 10), exp(1 / n * log(A / P)) * 100 - 100
	}
}'

# k=samples
TREND='{
	j = 1; i = k
	while (i <= NF) {
		ii = index($i, "-") - 1
		jj = index($j, "-") - 1
		n = substr($i, 1, ii) - substr($j, 1, jj)
		A = substr($i, ii + 12) + 0
		P = substr($j, jj + 12) + 0

		print substr($j, jj+2, 10), exp(1 / n * log(A / P)) * 100 - 100
		j += 1; i += 1
	}
}'

# left side plot with % daily change label
FOO='$2 != t {
	printf("%s %s ", $1, $2)

	if (t != 0)
		printf("%.1f%%\n", $2 / t * 100 - 100)
	else
		print "\\"

	t = $2 }'

# right side plot with totals label
BAR='NR != 1 { print l, ll }
{ l = $0; ll = $2 }
END { print l }'

for co in Illinois Kane 'Chicago|Cook' \
  'McHenry|Lake|Kane|DuPage|Kendall|Will|Grundy|Kankakee'; do
	for rs in 'confirmed cases' deaths 'total tested'; do
		la=`foo $co`
		echo  "$rs $la" >&2

		./totals select="$co" result="$rs" "$@" >tot
		awk "$FOO" tot | awk "$BAR" >total
		ta=`awk 'END { print $2 }' total`
		./plot -gs "$d 440,440" -oa.png -Ly -T%Y-%m-%d total

		awk '$2 != t { print NR "-" $1 $2; t = $2 }' tot >total
		awk "$TREND" RS= k=5 total >'5'
		awk "$TREND" RS= k=10 total >'10'
		awk "$TREND" RS= k=15 total >'15'
		awk "$TVM" RS= total >tvm
		ca=`awk '{ t += $2 } END { printf("%.1f%%", t / NR) }' tvm`
		<trends gnuplot

		exit

		convert a.png -trim +repage a.png
		convert b.png -trim +repage b.png
		convert a.png b.png -gravity center +append b.png
		gnuplot -c title pngcairo a.png "$da $la $ta $rs $ca"'chg'
		convert a.png -trim +repage a.png
		convert a.png b.png -gravity center -append "$co"-"$rs".png

		/bin/rm -f a.png b.png
		# no tested totals per county
		case "$co"-"$rs" in
		  Illinois-*)
			;;
		  *-deaths)
			break
			;;
		esac
	done
done
