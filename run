#!/bin/sh

#d=-dpng
d='-dpngcairo size 820,440'

awk() {
	/usr/bin/awk "$@"
}

paste() {
	/usr/bin/paste "$@"
}

tail() {
	/usr/bin/tail "$@"
}

foo() {
	shift $1;
	la="$1"
}

# set most recent input file
foo $# "$@"

foo() {
	printf '%s/%s/%s' $3 $4 $2
}

# set date
co="$IFS"
IFS=-
da=`foo $la` || exit
IFS="$co"

awk '/state_testing_results/ { F = 1 } F { print }' "$la" >\%chg
awk 'BEGIN { RS="," } $1 ~ /"total_tested":$/ { print $2 }' \%chg >tested
awk 'BEGIN { RS="," } $1 ~ /"confirmed_cases":$/ { print $2 }' \%chg >total
awk 'BEGIN { RS="," } $(NF - 1) ~ /"testDate":$/ { print $NF }' \%chg | \
  paste - total tested | >ratio awk \
 '$3 != 0 { L = 100 * $2 / $3; printf("%s %s %.1f%%\n", $1, L, L) }'
co=`awk '{ t += $2 } END { printf("%.1f%%", t / NR) }' ratio`
./plot -sgt "$da"' cases_{confirmed} / tested_{total} '"$co" \
  "$d" -o ratio.png -T '"%m/%d/%Y"' ratio

# split on |
foo() {
	echo $*
}
IFS='|'

# r = n[(A/P)^(1/nt) - 1]
TVM='{
	i = 1
	ii = index($i, "-") - 1

	j = substr($i, 1, ii) + 0
	P = substr($i, ii + 12) + 0

	while (i < NF) {
		i += 1
		ii = index($i, "-") - 1

		n = substr($i, 1, ii) - j
		A = substr($i, ii + 12) + 0

		print substr($i, ii + 2, 10), exp(1/n * log(A/P)), n
	}
}'

trend() {
	# k=samples
	awk '{
	j = 1; i = k
	while (i <= NF) {
		ii = index($i, "-") - 1
		jj = index($j, "-") - 1
		n = substr($i, 1, ii) - substr($j, 1, jj)
		A = substr($i, ii + 12) + 0
		P = substr($j, jj + 12) + 0

		print substr($i, ii + 2, 10), exp(1/n * log(A/P))
		j += 1; i += 1
	} }' RS= k="$1" $2
}

# doubling-time in hours
dhrs() {
	awk 'BEGIN { d = log(2) * 24 } { print $1, d/log($2) }' "$@"
}

predict() {
	paste "$@" | awk 'NR == 1 { P = $2; r = $4; next }
	NF < 5 { exit }
	{ print $3, P * exp($5 * log(r)); r = $4 }'
}

labels() {
	awk 'BEGIN { print 0 } { print $3 }' $2 | paste $1 - | awk '
	{ d[NR] = $1; v[NR] = $2; n[NR] = $3 }
	END {
		for (i = NR; i > 1; i--) {
			A = v[i]
			printf("%s %s ", d[i], A)

			s = sprintf("%.2e", A)
			split(s, a, "e")
			e = a[2]
			printf("%s\\n", a[1]);

			P = v[i - 1]
			printf("%.1f^%%\\n", exp(1/(n[i] - n[i - 1]) * log(A/P)))

			c = A - P
			if (c < 1000) {
				printf("%s\n", c)
				continue
			}

			e += 0
			split(sprintf("%.0e", c), a, "e")
			a[2] += 0
			if (e == a[2]) {
				s = sprintf("%.2e", c)
				split(s, a, "e")

				if (e == a[2]) {
					printf("%s\n", a[1])
					continue
				}

				s = a[1]
				printf(".%s\n", substr(s, 1, 1) substr(s, 3))
				continue
			}

			printf("%s_{10}^{%d}\n", a[1], e - a[2])
		}
	}'

	return
	  awk '{ t += $3 - l; l = $3 } t >= s { t -= s; print $1, $2, $2 }' \
	    s=`awk 'NR == 1 { i = $3 } END { print int(($3 - i)/35) + 1 }' $2`
}

FOO='{ printf("%s-%s-%s %s\n", $2, $3, substr($4, 1, 2), substr($4, 3)) }'

for co in Illinois Kane 'Chicago|Cook' \
  'McHenry|Lake|Kane|DuPage|Kendall|Will|Grundy|Kankakee'; do
	for rs in 'confirmed cases' deaths 'total tested'; do
		la=`foo $co`
		echo  "$rs $la" >&2

		./totals select="$co" result="$rs" "$@" >tot
		awk '$2 != t { print NR "-" $1 $2; t = $2 }' tot >total
		trend 5 total | dhrs >5
		trend 10 total | dhrs >10
		trend 15 total | dhrs >15
		awk "$TVM" RS= total >tvm
		pa=`awk 'END { printf("%.1f%%", $2 * 100 - 100) }' tvm`
		dhrs tvm >dhrs
		awk -F- "$FOO" total >tot
		ta=`awk 'END { print $2 }' tot`
		ca=`awk 'END { printf("%.2f", $2/24) }' dhrs`
		predict tot tvm >pred
		awk 'BEGIN { print; print } { print $2 }' pred | # filled-curve
		  paste tot - | # skip early point(s)
		  awk 'NF == 2 { next } { print }' >ftot
		labels tot tvm >labels

		# %chg for the last day
		p=`tail -2 total | trend 2 | awk '{ print $2 }'` || exit

		# amortized daily %chg 
		r=`awk 'END { print $2 }' tvm` || exit

		awk 'END { ti = t = $2
		for (i = -24; i >= -96; i -= 24) {
			t *= r; ti *= p
			print $1 i, ti, t } }' r="$r" p="$p" ftot >xtot

		for i in 5 10 15; do
			r=`tail -$i tvm | awk '{ print $2; exit }'`
			>x$i awk 'END { t = $2
				for (i = -24; i >= -96; i -= 24) {
					t *= r
					print $1 i, t } }' r="$r" ftot
		done

		awk '$2 != t { print NR "-" $1 $2; t = $2 }' dhrs >fdhrs
		p=`tail -2 fdhrs | trend 2 | awk '{ print $2 }'` || exit
		awk -F- "$FOO" fdhrs >dhrs
		awk 'NR != 1 { print $0, d } { d = $2 }' dhrs >fdhrs
		awk 'END { t = $2
		for (i = -24; i >= -96; i -= 24) {
			t *= p
			print $1 i, t, $2 } }' p="$p" fdhrs >xdhrs

		gnuplot -c trends "$da $la $pa" "$ta $rs" "$ca"
		/bin/mv a.png "$co"-"$rs".png || exit
		exit

		# no tested totals per county
		case "$co"-"$rs" in
		  Illinois-*)
			;;
		  *-deaths)
			break
			;;
		esac
	done
done
