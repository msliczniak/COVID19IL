#!/bin/sh

#d=-dpng
d='-dpngcairo size'

awk() {
	/usr/bin/awk "$@"
}

foo() {
	shift $1;
	echo "$1" | sed 's/[^-]*-//; s/T.*//'
}

da=`foo $# "$@"`

for co in Illinois Kane 'Chicago|Cook' \
  'McHenry|Lake|Kane|DuPage|Kendall|will|Grundy|Kankakee'; do
	for rs in 'confirmed cases' deaths 'total tested'; do
		./totals select="$co" result="$rs" "$@" | \
		  awk '{print NR-1,$1,$1}' >total

		# if there is zero, don't gen plots
		awk 'BEGIN{s=1}$1!="0"{s=0;exit}END{exit s}' total || break

		./plot -gst "$da $co" "$d 555,440" -o a.png -Ly total

		awk '{print $2}' total | ./cum | \
		  awk 'NF==2{print NR-1,$2}' | tail>\%chg
		./plot -gst "$rs"' %chg' "$d 245,440" -o b.png \%chg

		convert +append a.png b.png +dither -colors 8 "$co"-"$rs".gif
		/bin/rm -f a.png b.png

		# no tested totals per county
		case "$co"-"$rs" in
		  Illinois-*)
			;;
		  *-deaths)
			break
			;;
		esac
	done
done
