#!/bin/sh

# This is a best guess at matching cases cause there is no ID and later files
# have corrections like the age of the patient.

awk() {
	/usr/bin/awk "$@"
}

mv() {
	/bin/mv "$@"
}

rm() {
	/bin/rm "$@"
}

sort() {
	/usr/bin/sort -t, -k4,4 -k1,1 -k2,2 -k5,5 -k3,3 "$@"
}

# create report(s)
p=`./report "$@"`
case x"$p" in
  x)
	exit
	;;
esac
printf '%s\n' "$p"

# reverse order
set -- `printf '%s\n' report-*.csv | #
awk '{ a[++i] = $0 } END { while (i) print a[i--] }'`

# most recent
p="$1"; shift

case $# in
  0)
	exit
	;;
esac

# correct erroneously zeroed ages
./merge f="$1" <"$p" >c || exit
mv c "$p" || exit

for i in "$@"; do
	>&2 printf ': %s\n' "$i"

	./ndiff -q "$i" "$p" >c || exit
	exec <c && rm c && ./super | sort >c || exit
	mv c "$i" || exit

	p="$i"
done
